{% extends 'main/base.html' %}
{% block title %}
{{ request.user.username }}'s cart
{% endblock%}

{% block content %}

<div class="container-fluid">
    <div class="col-12">
        <div class="col-11 mx-auto my-5">
            <table id="productTable" class="table table-light table-hover text-center align-middle">
                <thead>
                    <tr>
                        <th class="text-center">Image</th>
                        <th class="text-center">Title</th>
                        <th class="text-center">Collection</th>
                        <th class="text-center">Year</th>
                        <th class="text-center">Brand</th>
                        <th class="text-center">Size</th>
                        <th class="text-center">Type</th>
                        <th class="text-center">Price</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in cart.product.all %}
                    {% include './includes/singleProductRow.html' %}
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <th>Total: <span id="totalPrice"></span></th>
                        <td>
                            <button type="button"
                                class="btn btn-success {% if not cart.product.all %} disabled {% endif %}"
                                data-bs-toggle="modal" data-bs-target="#exampleModal">
                                <i class="fa-solid fa-cash-register"></i>&nbsp;Go to checkout
                            </button>
                        </td>
                    </tr>
                    <script>
                        let price = 0.0;
                        "{% for product in cart.product.all %}"
                        currPrice = parseFloat("{{ product.price }}");
                        price += currPrice;
                        "{% endfor %}"
                        $("#totalPrice").html(price.toFixed(2) + " HRK");
                    </script>
                </tfoot>
            </table>
            <script>
                $(document).ready(function () {
                    $('.dataTables_length').addClass('bs-select');
                    $("#productTable_filter>label>input").attr("placeholder", "Type here to search");
                });
            </script>
        </div>
    </div>
</div>

<div class="modal fade" id="exampleModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel"><b>Receipt</b> [<span class="text-muted">{{ request.session.session_key }}</span>]</h5>
            </div>
            <div class="modal-body row align-items-center">
                <div class="col-6 text-center">
                    <b>Total price:</b> {{ cart.getTotalPrice }} HRK
                </div>
                <div class="col-6 text-center">
                    <b>User:</b> {{ request.user.username }}
                </div>
                <div class="col-10 mx-auto text-center">
                    <hr>
                </div>
                <div class="col-10 mx-auto text-center mb-3">
                    <span class="h5">Address</span>&nbsp;&nbsp;&nbsp;&nbsp;<span><a
                            class="btn btn-outline-warning btn-sm"
                            href="{% url 'account:editAccount' request.user.id %}"><i
                                class="fa-solid fa-pen-to-square"></i></a></span>
                </div>
                <div class="col-12 text-center">
                    <span id="userAddress">{{ request.user.address }}</span>
                </div>
                <div class="col-10 mx-auto text-center mb-3">
                    <hr>
                    <h5>Deliver Purchase</h5>
                </div>
                <div class="col-10 mx-auto text-center">
                    <div class="input-group">
                        <div class="form-check mx-auto">
                            <input class="form-check-input" type="radio" name="flexRadioDefault" id="addressRb" checked>
                            <label class="form-check-label" for="addressRb">To Address</label>
                        </div>
                        <div class="form-check mx-auto">
                            <input class="form-check-input" type="radio" name="flexRadioDefault" id="localStoreRb">
                            <label class="form-check-label" for="localStoreRb">To Local Store</label>
                        </div>
                    </div>
                </div>
                <div class="col-10 mx-auto text-center d-none p-2 mt-3 text-warning" id="returning">
                    <p>Returning to main page in 3 seconds...</p>
                </div>
                <script>
                    $('input:radio').change(function () {
                        if ($("#addressRb").is(":checked")) {
                            $("#userAddress").css("text-decoration", "none").removeClass("text-muted");
                            $("#pod").removeClass("d-none").addClass("d-block");
                        }
                        else {
                            $("#userAddress").css("text-decoration", "line-through").addClass("text-muted");
                            $("#pod").addClass("d-none").removeClass("d-block");
                        }
                    });
                </script>
            </div>
            <div class="modal-footer">
                <div class="mt-3 text-danger me-auto" id="pod">* payment on delivery.</div>
                <button type="button" class="btn btn-outline-dark" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="confirmPurchase">Confirm purchase</button>
            </div>
        </div>
    </div>
</div>

<script>
    $('#confirmPurchase').click(function(){
        $.ajax({
            url: "{% url 'main:checkoutFinal' %}",
            type: "POST",
            data: {
                "id": "{{ cart.id }}",
                "receiptNumber": "{{ request.session.session_key }}" ,
                csrfmiddlewaretoken: '{{ csrf_token }}',
            },
            cache: false,
            dataType: "json",
            success: function (data) {
                    setTimeout(function () {
                        window.location = "{% url 'main:index' %}";
                    }, 3000);   
                    $(this).html("Purchased");
                    $('#returning').removeClass("d-none").addClass("d-block");     
            }
        });

        
    })
  
    </script>
{% endblock%}